---
// Popular Posts Widget Component - Simple & Stable Version
import { getCollection } from 'astro:content';

const posts = await getCollection('blog');

// Sort posts by popularity (views, featured, publish date)
const popularPosts = posts
  .sort((a, b) => {
    // Priority: Featured posts first, then by views, then by date
    if (a.data.featured && !b.data.featured) return -1;
    if (!a.data.featured && b.data.featured) return 1;
    
    const aViews = (a.data as any).views || 0;
    const bViews = (b.data as any).views || 0;
    
    if (aViews !== bViews) return bViews - aViews;
    
    return b.data.publishDate.valueOf() - a.data.publishDate.valueOf();
  });

export interface Props {
  class?: string;
  maxPosts?: number;
  showViews?: boolean;
  title?: string;
}

const { 
  class: className, 
  maxPosts = 5, 
  showViews = true,
  title = "Artikel Populer"
} = Astro.props;

const displayPosts = popularPosts.slice(0, maxPosts);
---

<div class={`popular-posts ${className || ''}`}>
  <div class="popular-posts-header">
    <h3 class="text-lg font-bold text-neutral-800">{title}</h3>
    <p class="text-xs text-neutral-500">Artikel populer</p>
  </div>
  
  <div class="popular-posts-content">
    <div class="popular-list">
      {displayPosts.map((post, index) => {
        const publishDate = post.data.publishDate.toLocaleDateString('id-ID', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
        
        return (
          <div class={`popular-item ${index === 0 ? 'featured' : ''}`} data-rank={index + 1}>
            <div class="popular-rank">
              <span class="rank-number">{index + 1}</span>
            </div>
            
            <div class="popular-content">
              <h4 class="popular-title">
                <a href={`/blog/${post.slug}`}>{post.data.title}</a>
              </h4>
              
              <div class="popular-meta">
                <span class="popular-category">{post.data.category}</span>
                <span class="popular-date">{publishDate}</span>
                {showViews && (post.data as any).views && (
                  <span class="popular-views">{(post.data as any).views} views</span>
                )}
              </div>
              
              {post.data.description && (
                <p class="popular-description">{post.data.description}</p>
              )}
              
              <div class="popular-footer">
                {post.data.readingTime && (
                  <span class="reading-time">{post.data.readingTime} min</span>
                )}
                {post.data.featured && (
                  <span class="featured-badge">‚≠ê Featured</span>
                )}
              </div>
            </div>
          </div>
        );
      })}
    </div>
    
    {posts.length > maxPosts && (
      <div class="popular-footer">
        <button class="show-more-popular" id="show-more-popular">
          Lihat Semua Artikel ({posts.length})
        </button>
      </div>
    )}
  </div>
</div>

<script>
  // Simple and stable PopularPosts functionality
  function initPopularPosts() {
    const showMoreBtn = document.getElementById('show-more-popular');
    const popularList = document.querySelector('.popular-list');
    
    if (!showMoreBtn || !popularList) return;
    
    let isExpanded = false;
    const allPosts = Array.from(popularList.children);
    const maxDisplayed = parseInt(showMoreBtn.textContent?.match(/\d+/)?.[0] || '5');
    
    // Store original posts for toggle
    const originalPosts = Array.from(allPosts);
    
    showMoreBtn.addEventListener('click', () => {
      isExpanded = !isExpanded;
      
      if (isExpanded) {
        // Show all posts
        popularList.innerHTML = '';
        originalPosts.forEach(post => {
          popularList.appendChild(post.cloneNode(true));
        });
        showMoreBtn.textContent = 'Tampilkan Lebih Sedikit';
      } else {
        // Show limited posts
        popularList.innerHTML = '';
        originalPosts.slice(0, maxDisplayed).forEach(post => {
          popularList.appendChild(post.cloneNode(true));
        });
        showMoreBtn.textContent = `Lihat Semua Artikel (${originalPosts.length})`;
      }
    });
    
    // Track clicks for analytics
    popularList.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      const link = target?.closest('a');
      if (link && typeof window !== 'undefined' && (window as any).gtag) {
        (window as any).gtag('event', 'popular_post_click', {
          event_category: 'engagement',
          event_label: link.href,
          value: 1
        });
      }
    });
    
    // Track widget view
    if (typeof window !== 'undefined' && (window as any).gtag) {
      (window as any).gtag('event', 'popular_posts_view', {
        event_category: 'engagement',
        event_label: 'popular_posts_widget'
      });
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPopularPosts);
  } else {
    initPopularPosts();
  }
</script>

<style>
  @reference "@/styles/global.css";
  .popular-posts {
    @apply bg-white rounded-2xl p-4 shadow-lg border border-neutral-100;
  }

  .popular-posts-header {
    @apply mb-4;
  }

  .popular-posts-content {
    @apply space-y-3;
  }

  .popular-list {
    @apply space-y-3;
  }

  .popular-item {
    @apply flex gap-3 p-3 bg-gradient-to-r from-neutral-50 to-neutral-100 rounded-lg hover:from-primary-50 hover:to-secondary-50 transition-all duration-200 hover:transform hover:-translate-y-0.5 hover:shadow-sm;
  }

  .popular-item.featured {
    @apply from-primary-50 to-secondary-50 border border-primary-200;
  }

  .popular-rank {
    @apply flex-shrink-0 w-8 h-8 bg-primary-500 text-white rounded-full flex items-center justify-center font-bold text-sm;
  }

  .popular-item.featured .popular-rank {
    @apply bg-gradient-to-r from-primary-500 to-secondary-500;
  }

  .popular-content {
    @apply flex-1 min-w-0;
  }

  .popular-title {
    @apply text-sm font-semibold mb-2 line-clamp-2;
  }

  .popular-title a {
    @apply text-neutral-800 hover:text-primary-600 transition-colors;
  }

  .popular-meta {
    @apply flex items-center gap-2 mb-2 text-xs text-neutral-500;
  }

  .popular-category {
    @apply px-2 py-1 bg-primary-100 text-primary-700 rounded-full font-medium text-xs;
  }

  .popular-date {
    @apply text-neutral-500;
  }

  .popular-views {
    @apply text-neutral-400;
  }

  .popular-description {
    @apply text-xs text-neutral-600 mb-2 line-clamp-2;
  }

  .popular-footer {
    @apply flex items-center justify-between text-xs text-neutral-500;
  }

  .reading-time {
    @apply px-2 py-1 bg-neutral-200 text-neutral-600 rounded text-xs;
  }

  .featured-badge {
    @apply px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full font-medium text-xs;
  }

  .popular-footer {
    @apply text-center pt-4 border-t border-neutral-100;
  }

  .show-more-popular {
    @apply px-4 py-2 bg-primary-500 text-white rounded-lg text-sm font-medium hover:bg-primary-600 transition-colors;
  }

  /* Dark mode styles */
  .dark .popular-posts {
    @apply bg-neutral-800 border-neutral-700;
  }

  .dark .popular-item {
    @apply from-neutral-700 to-neutral-800 hover:from-primary-900 hover:to-secondary-900;
  }

  .dark .popular-item.featured {
    @apply from-primary-900 to-secondary-900 border-primary-700;
  }

  .dark .popular-title a {
    @apply text-neutral-100 hover:text-primary-400;
  }

  .dark .popular-description {
    @apply text-neutral-300;
  }

  .dark .popular-meta {
    @apply text-neutral-400;
  }

  .dark .popular-footer {
    @apply border-neutral-700;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .popular-posts {
      @apply p-3;
    }
    
    .popular-item {
      @apply flex-col gap-2 p-3;
    }
    
    .popular-rank {
      @apply w-6 h-6 text-xs;
    }
    
    .popular-title {
      @apply text-base;
    }
    
    .popular-meta {
      @apply flex-col gap-1 items-start;
    }
    
    .popular-footer {
      @apply flex-col gap-2 items-start;
    }
  }

  /* Animation for hover effects */
  .popular-item {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .popular-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }

  /* Featured post special styling */
  .popular-item.featured {
    position: relative;
    overflow: hidden;
  }

  .popular-item.featured::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #3b82f6, #14b8a6);
  }

  /* Smooth transitions for show/hide */
  .popular-list {
    transition: all 0.3s ease-in-out;
  }

  /* Button hover effects */
  .show-more-popular:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  .show-more-popular:active {
    transform: translateY(0);
  }
</style>
